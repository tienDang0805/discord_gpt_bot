# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Bước 1: Checkout code để lấy thông tin commit cho việc gửi thông báo
      - name: Checkout code
        uses: actions/checkout@v4

      # Bước 2: Kết nối SSH và thực hiện tất cả công việc trên server của bạn
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e # Dừng ngay lập tức nếu có lỗi

            echo ">>> Kích hoạt môi trường NVM và Node.js..."
            # Tải và kích hoạt NVM (Node Version Manager)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo ">>> Di chuyển đến thư mục dự án..."
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> Kéo code mới nhất từ nhánh main..."
            git checkout main
            git pull origin main

            echo ">>> Sử dụng Node.js phiên bản 22..."
            nvm use 22

            echo ">>> Cài đặt các gói phụ thuộc cho production..."
            npm install --production

            echo ">>> Tạo file .env từ GitHub Secrets..."
            # ✅ SỬA LỖI Ở ĐÂY: Dùng cat <<EOF là cách an toàn và đúng đắn nhất
            # Nó ghi toàn bộ khối văn bản vào file, bất kể có ký tự đặc biệt hay nhiều dòng
            cat <<EOF > src/.env
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            YOUTUBE_COOKIE='${{ secrets.YOUTUBE_COOKIE }}'
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            SYSTEM_PROMPT="${{ secrets.SYSTEM_PROMPT }}"
            EOF
            
            echo ">>> Khởi động lại bot bằng PM2..."
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save

            echo "✅ Triển khai thành công!"

      # Bước 3: Gửi thông báo đến Discord (gọn gàng và chuyên nghiệp hơn)
      - name: Send Discord Notification
        uses: navanee-w/discord-notification@v1
        with:
          # Dùng webhook an toàn hơn, lấy từ Kênh Discord -> Tích hợp -> Webhooks
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "🚀 Triển khai thành công!"
          description: |
            Bot **Em Bé Racoon** đã được cập nhật thành công.
            **Người triển khai:** `${{ github.actor }}`
            **Commit:** `[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`
          color: "3447003" # Màu xanh
          timestamp: true