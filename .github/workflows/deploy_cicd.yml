# .github/workflows/deploy.yml
name: Deploy Discord Bot # TÃªn cá»§a luá»“ng cÃ´ng viá»‡c nÃ y, sáº½ hiá»ƒn thá»‹ trong tab 'Actions'

# KÃ­ch hoáº¡t luá»“ng cÃ´ng viá»‡c nÃ y má»—i khi cÃ³ code Ä‘Æ°á»£c Ä‘áº©y lÃªn nhÃ¡nh 'main'
on:
  push:
    branches:
      - main

# Äá»‹nh nghÄ©a má»™t cÃ´ng viá»‡c (job) duy nháº¥t cÃ³ tÃªn 'deploy'
jobs:
  deploy:
    # CÃ´ng viá»‡c nÃ y sáº½ cháº¡y trÃªn má»™t mÃ¡y áº£o Ubuntu má»›i tinh do GitHub cung cáº¥p
    runs-on: ubuntu-latest

    # CÃ¡c bÆ°á»›c (steps) Ä‘á»‹nh nghÄ©a chuá»—i cÃ¡c hÃ nh Ä‘á»™ng cáº§n thá»±c hiá»‡n
    steps:
      - name: Checkout code # BÆ°á»›c 1: Táº£i mÃ£ nguá»“n tá»« kho chá»©a GitHub cá»§a báº¡n
        uses: actions/checkout@v4 # Sá»­ dá»¥ng action cÃ³ sáºµn Ä‘á»ƒ táº£i code

      - name: Set up Node.js environment # BÆ°á»›c 2: CÃ i Ä‘áº·t Node.js trÃªn mÃ¡y áº£o GitHub Actions
        uses: actions/setup-node@v4
        with:
          node-version: '22' # Chá»n phiÃªn báº£n Node.js (nÃªn dÃ¹ng phiÃªn báº£n LTS nhÆ° 18 hoáº·c 20)

      - name: Install Node.js dependencies # BÆ°á»›c 3: CÃ i Ä‘áº·t cÃ¡c gÃ³i npm cáº§n thiáº¿t cho bot cá»§a báº¡n
        run: npm install

      - name: Install system dependencies (FFmpeg, Opus) # BÆ°á»›c 4: CÃ i Ä‘áº·t cÃ¡c gÃ³i Linux cáº§n thiáº¿t cho chá»©c nÄƒng thoáº¡i
        run: |
          sudo apt update
          sudo apt install -y ffmpeg libopus-dev

      - name: Deploy to Server via SSH # BÆ°á»›c 5: Káº¿t ná»‘i Ä‘áº¿n server cá»§a báº¡n vÃ  triá»ƒn khai code
        uses: appleboy/ssh-action@v1.0.3 # Sá»­ dá»¥ng action cÃ³ sáºµn Ä‘á»ƒ káº¿t ná»‘i SSH
        with:
          host: ${{ secrets.SERVER_HOST }} # Láº¥y Ä‘á»‹a chá»‰ host tá»« GitHub Secrets
          username: ${{ secrets.SERVER_USERNAME }} # Láº¥y tÃªn ngÆ°á»i dÃ¹ng tá»« GitHub Secrets
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Láº¥y private key SSH tá»« GitHub Secrets
          # Khá»‘i 'script' chá»©a cÃ¡c lá»‡nh sáº½ Ä‘Æ°á»£c thá»±c thi trá»±c tiáº¿p trÃªn server cá»§a báº¡n
          script: |
            # Chuyá»ƒn Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n bot trÃªn server
            cd ${{ secrets.PROJECT_PATH }}

            # Kiá»ƒm tra xem repository Git Ä‘Ã£ Ä‘Æ°á»£c clone chÆ°a (láº§n triá»ƒn khai Ä‘áº§u tiÃªn so vá»›i cÃ¡c láº§n sau)
            if [ -d ".git" ]; then
              echo "Repository Git Ä‘Ã£ tá»“n táº¡i, Ä‘ang kÃ©o cÃ¡c thay Ä‘á»•i má»›i nháº¥t..."
              git pull origin main # KÃ©o thay Ä‘á»•i náº¿u kho mÃ£ Ä‘Ã£ tá»“n táº¡i
            else
              echo "KhÃ´ng tÃ¬m tháº¥y Repository Git, Ä‘ang clone láº§n Ä‘áº§u..."
              # Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ  tÃªn repo tá»« biáº¿n mÃ´i trÆ°á»ng cá»§a GitHub Actions
              git clone https://github.com/${{ github.repository }}.git . # Clone náº¿u lÃ  láº§n triá»ƒn khai Ä‘áº§u tiÃªn
            fi

            # CÃ i Ä‘áº·t láº¡i cÃ¡c gÃ³i Node.js trÃªn server (quan trá»ng sau khi kÃ©o code má»›i)
            # DÃ¹ng --production Ä‘á»ƒ chá»‰ cÃ i Ä‘áº·t cÃ¡c gÃ³i cáº§n thiáº¿t cho mÃ´i trÆ°á»ng cháº¡y bot
            npm install --production

            # Táº¡o hoáº·c cáº­p nháº­t file .env trÃªn server báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c GitHub Secrets
            echo "DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}" >> .env

            # Khá»Ÿi Ä‘á»™ng láº¡i bot báº±ng PM2
            # 'pm2 reload' sáº½ reload náº¿u bot Ä‘ang cháº¡y; '|| pm2 start' sáº½ cháº¡y bot náº¿u nÃ³ chÆ°a cháº¡y
            pm2 save # LÆ°u tráº¡ng thÃ¡i cÃ¡c tiáº¿n trÃ¬nh PM2
            pm2 reload racoon-8d-bot || pm2 start index.js --name "racoon-8d-bot"
            echo "Bot Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai vÃ  khá»Ÿi Ä‘á»™ng láº¡i thÃ nh cÃ´ng!"
               echo '
            const { Client, GatewayIntentBits } = require("discord.js");
            const dotenv = require("dotenv");
            dotenv.config();

            const token = process.env.DISCORD_TOKEN;
            const channelId = process.env.DISCORD_CHANNEL_ID;
            const guildId = process.env.GUILD_ID; // Cáº§n thiáº¿t náº¿u bot pháº£i join guild trÆ°á»›c

            if (!token || !channelId) {
                console.error("Thiáº¿u DISCORD_TOKEN hoáº·c DISCORD_CHANNEL_ID trong .env");
                process.exit(1);
            }

            const client = new Client({
                intents: [
                    GatewayIntentBits.Guilds,
                    GatewayIntentBits.GuildMessages,
                    GatewayIntentBits.MessageContent
                ]
            });

            client.once("ready", async () => {
                console.log(`ÄÄƒng nháº­p vá»›i vai trÃ² ${client.user.tag}!`);
                try {
                    const guild = client.guilds.cache.get(guildId);
                    if (!guild) {
                        console.error(`KhÃ´ng tÃ¬m tháº¥y guild vá»›i ID: ${guildId}`);
                        return;
                    }
                    const channel = guild.channels.cache.get(channelId);
                    if (channel && channel.isTextBased()) {
                        const commitSha = process.env.GITHUB_SHA ? process.env.GITHUB_SHA.substring(0, 7) : "N/A";
                        const commitUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}/commit/${process.env.GITHUB_SHA}`;
                        const repositoryUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}`;

                        await channel.send(
                            `ğŸš€ **Triá»ƒn khai thÃ nh cÃ´ng!**\n` +
                            `**Bot:** ${client.user.tag}\n` +
                            `**PhiÃªn báº£n:** ${process.env.GITHUB_REF_NAME || "main"}\n` +
                            `**Commit:** [${commitSha}](${commitUrl})\n` +
                            `**Repository:** ${repositoryUrl}\n` +
                            `Bot Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t vÃ  khá»Ÿi Ä‘á»™ng láº¡i thÃ nh cÃ´ng.`
                        );
                        console.log("ÄÃ£ gá»­i tin nháº¯n thÃ´ng bÃ¡o triá»ƒn khai thÃ nh cÃ´ng.");
                    } else {
                        console.error(`KhÃ´ng tÃ¬m tháº¥y kÃªnh vÄƒn báº£n vá»›i ID: ${channelId}`);
                    }
                } catch (error) {
                    console.error("Lá»—i khi gá»­i tin nháº¯n Discord:", error);
                } finally {
                    client.destroy(); // Äáº£m báº£o client ngáº¯t káº¿t ná»‘i sau khi gá»­i
                }
            });

            client.login(token);
            ' > send_deploy_notification.js

            # Cháº¡y script gá»­i thÃ´ng bÃ¡o. CÃ³ thá»ƒ thÃªm sleep náº¿u bot cáº§n thÃªm thá»i gian Ä‘á»ƒ khá»Ÿi Ä‘á»™ng.
            sleep 5 # Äá»£i 5 giÃ¢y Ä‘á»ƒ bot cháº¯c cháº¯n khá»Ÿi Ä‘á»™ng láº¡i
            node ./send_deploy_notification.js

            # XÃ³a script táº¡m thá»i sau khi dÃ¹ng xong
            rm send_deploy_notification.js
            ```
