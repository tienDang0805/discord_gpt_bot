# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo ">>> K√≠ch ho·∫°t m√¥i tr∆∞·ªùng NVM v√† Node.js..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo ">>> Di chuy·ªÉn ƒë·∫øn th∆∞ m·ª•c d·ª± √°n..."
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> K√©o code m·ªõi nh·∫•t t·ª´ nh√°nh main..."
            git checkout main
            git pull origin main

            echo ">>> S·ª≠ d·ª•ng Node.js phi√™n b·∫£n 22..."
            nvm use 22

            # QUAN TR·ªåNG: C√†i ƒë·∫∑t T·∫§T C·∫¢ dependencies, bao g·ªìm c·∫£ discord.js ƒë·ªÉ script c√≥ th·ªÉ ch·∫°y
            echo ">>> C√†i ƒë·∫∑t c√°c g√≥i ph·ª• thu·ªôc..."
            npm install

            echo ">>> T·∫°o file .env t·ª´ GitHub Secrets..."
            cat <<EOF > src/.env
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            YOUTUBE_COOKIE='${{ secrets.YOUTUBE_COOKIE }}'
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            SYSTEM_PROMPT="${{ secrets.SYSTEM_PROMPT }}"
            EOF
            
            echo ">>> Kh·ªüi ƒë·ªông l·∫°i bot b·∫±ng PM2..."
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save
            echo "‚úÖ Bot ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai v√† kh·ªüi ƒë·ªông l·∫°i!"

            # --- SCRIPT G·ª¨I TH√îNG B√ÅO DISCORD NH∆Ø Y√äU C·∫¶U ---
            echo ">>> T·∫°o v√† ch·∫°y script g·ª≠i th√¥ng b√°o Discord..."
            # Truy·ªÅn c√°c bi·∫øn m√¥i tr∆∞·ªùng c·ªßa GitHub v√†o script Node.js
            cat << EOF_NODE_SCRIPT > send_deploy_notification.js
            const { Client, GatewayIntentBits } = require("discord.js");
            const dotenv = require("dotenv");
            dotenv.config({ path: './src/.env' });

            // L·∫•y th√¥ng tin t·ª´ c√°c bi·∫øn m√¥i tr∆∞·ªùng
            const token = process.env.DISCORD_TOKEN;
            const channelId = process.env.DISCORD_CHANNEL_ID;
            const commitSha = process.env.GITHUB_SHA ? process.env.GITHUB_SHA.substring(0, 7) : "N/A";
            const repoUrl = \`https://github.com/\${process.env.GITHUB_REPOSITORY}\`;
            const commitUrl = \`\${repoUrl}/commit/\${process.env.GITHUB_SHA}\`;
            const actor = process.env.GITHUB_ACTOR || "Unknown";

            if (!token || !channelId) {
                console.error("L·ªói: Thi·∫øu DISCORD_TOKEN ho·∫∑c DISCORD_CHANNEL_ID trong file .env");
                process.exit(1);
            }

            const client = new Client({ intents: [GatewayIntentBits.Guilds] });

            client.once("ready", async () => {
                try {
                    const channel = await client.channels.fetch(channelId);
                    if (channel && channel.isTextBased()) {
                        await channel.send(
                            \`üöÄ **Tri·ªÉn khai th√†nh c√¥ng!**\n\` +
                            \`**Ng∆∞·ªùi tri·ªÉn khai:** \`\${actor}\`\n\` +
                            \`**Commit:** [\${commitSha}](\${commitUrl})\n\` +
                            \`Bot ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† kh·ªüi ƒë·ªông l·∫°i.\`
                        );
                        console.log("ƒê√£ g·ª≠i th√¥ng b√°o tri·ªÉn khai th√†nh c√¥ng.");
                    } else {
                        console.error(\`Kh√¥ng t√¨m th·∫•y k√™nh ho·∫∑c k√™nh kh√¥ng ph·∫£i l√† k√™nh vƒÉn b·∫£n: \${channelId}\`);
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ª≠i tin nh·∫Øn Discord:", error);
                } finally {
                    client.destroy();
                }
            });

            client.login(token).catch(err => {
                console.error("L·ªói ƒëƒÉng nh·∫≠p Discord:", err);
                process.exit(1);
            });
            EOF_NODE_SCRIPT

            # Ch·ªù m·ªôt ch√∫t ƒë·ªÉ bot ch√≠nh kh·ªüi ƒë·ªông l·∫°i ho√†n to√†n
            sleep 5
            # Ch·∫°y script b·∫±ng Node.js v√† truy·ªÅn c√°c bi·∫øn m√¥i tr∆∞·ªùng c·ªßa GitHub v√†o
            GITHUB_SHA="${{ github.sha }}" GITHUB_REPOSITORY="${{ github.repository }}" GITHUB_ACTOR="${{ github.actor }}" node ./send_deploy_notification.js
            
            # X√≥a file script t·∫°m th·ªùi
            rm send_deploy_notification.js