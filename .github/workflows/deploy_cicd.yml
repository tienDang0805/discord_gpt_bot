# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # B∆∞·ªõc 1: Ch·ªâ c·∫ßn checkout code ƒë·ªÉ l·∫•y th√¥ng tin commit cho th√¥ng b√°o
      - name: Checkout code
        uses: actions/checkout@v4

      # B∆∞·ªõc 2: K·∫øt n·ªëi SSH v√† th·ª±c hi·ªán t·∫•t c·∫£ c√°c h√†nh ƒë·ªông tr√™n server
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e # Tho√°t ngay l·∫≠p t·ª©c n·∫øu c√≥ l·ªói

            # T·∫£i v√† k√≠ch ho·∫°t NVM (Node Version Manager)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Chuy·ªÉn ƒë·∫øn th∆∞ m·ª•c d·ª± √°n
            cd ${{ secrets.PROJECT_PATH }}

            echo "K√©o c√°c thay ƒë·ªïi m·ªõi nh·∫•t t·ª´ nh√°nh main..."
            git checkout main # ƒê·∫£m b·∫£o ƒëang ·ªü nh√°nh main
            git pull origin main # K√©o code m·ªõi nh·∫•t

            echo "S·ª≠ d·ª•ng Node.js phi√™n b·∫£n 22..."
            nvm use 22

            echo "C√†i ƒë·∫∑t c√°c g√≥i Node.js c·∫ßn thi·∫øt cho production..."
            npm install --production

            echo "T·∫°o file .env t·ª´ GitHub Secrets..."
            # S·ª≠ d·ª•ng cat EOF ƒë·ªÉ t·∫°o file, an to√†n h∆°n cho c√°c bi·∫øn c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát
            cat <<EOF > src/.env
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            SYSTEM_PROMPT=${{ secrets.SYSTEM_PROMPT }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            YOUTUBE_COOKIE='${{ secrets.YOUTUBE_COOKIE }}'
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            EOF
            
            echo "Kh·ªüi ƒë·ªông l·∫°i bot b·∫±ng PM2..."
            # 'restart' s·∫Ω kh·ªüi ƒë·ªông n·∫øu ch∆∞a ch·∫°y, ho·∫∑c kh·ªüi ƒë·ªông l·∫°i n·∫øu ƒëang ch·∫°y
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save # L∆∞u l·∫°i danh s√°ch process

            echo "Tri·ªÉn khai th√†nh c√¥ng!"

      # B∆∞·ªõc 3: G·ª≠i th√¥ng b√°o ƒë·∫øn Discord (s·∫°ch s·∫Ω v√† chuy√™n nghi·ªáp h∆°n)
      - name: Send Discord Notification
        uses: navanee-w/discord-notification@v1
        with:
          # S·ª≠ d·ª•ng webhook URL thay v√¨ bot token, an to√†n h∆°n cho vi·ªác ch·ªâ g·ª≠i tin nh·∫Øn
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ Tri·ªÉn khai th√†nh c√¥ng!"
          description: |
            Bot **Em B√© Racoon** ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.
            **Ng∆∞·ªùi tri·ªÉn khai:** `${{ github.actor }}`
            **Commit:** `[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`
          color: "3447003" # M√†u xanh l√° c√¢y
          timestamp: true
          footer_text: "Repository: ${{ github.repository }}"