# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # BÆ°á»›c 1: Checkout code Ä‘á»ƒ láº¥y thÃ´ng tin commit cho viá»‡c gá»­i thÃ´ng bÃ¡o
      - name: Checkout code
        uses: actions/checkout@v4

      # BÆ°á»›c 2: Káº¿t ná»‘i SSH vÃ  thá»±c hiá»‡n táº¥t cáº£ cÃ´ng viá»‡c trÃªn server cá»§a báº¡n
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e # Dá»«ng ngay láº­p tá»©c náº¿u cÃ³ lá»—i

            echo ">>> KÃ­ch hoáº¡t mÃ´i trÆ°á»ng NVM vÃ  Node.js..."
            # Táº£i vÃ  kÃ­ch hoáº¡t NVM (Node Version Manager)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo ">>> Di chuyá»ƒn Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n..."
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> KÃ©o code má»›i nháº¥t tá»« nhÃ¡nh main..."
            git checkout main
            git pull origin main

            echo ">>> Sá»­ dá»¥ng Node.js phiÃªn báº£n 22..."
            nvm use 22

            echo ">>> CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c cho production..."
            npm install --production

            echo ">>> Táº¡o file .env tá»« GitHub Secrets..."
            # âœ… Sá»¬A Lá»–I á» ÄÃ‚Y: DÃ¹ng cat <<EOF lÃ  cÃ¡ch an toÃ n vÃ  Ä‘Ãºng Ä‘áº¯n nháº¥t
            # NÃ³ ghi toÃ n bá»™ khá»‘i vÄƒn báº£n vÃ o file, báº¥t ká»ƒ cÃ³ kÃ½ tá»± Ä‘áº·c biá»‡t hay nhiá»u dÃ²ng
            cat <<EOF > src/.env
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            YOUTUBE_COOKIE='${{ secrets.YOUTUBE_COOKIE }}'
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            SYSTEM_PROMPT="${{ secrets.SYSTEM_PROMPT }}"
            EOF
            
            echo ">>> Khá»Ÿi Ä‘á»™ng láº¡i bot báº±ng PM2..."
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save

            echo "âœ… Triá»ƒn khai thÃ nh cÃ´ng!"

      # BÆ°á»›c 3: Gá»­i thÃ´ng bÃ¡o Ä‘áº¿n Discord (gá»n gÃ ng vÃ  chuyÃªn nghiá»‡p hÆ¡n)
      - name: Send Discord Notification
        uses: navanee-w/discord-notification@v1
        with:
          # DÃ¹ng webhook an toÃ n hÆ¡n, láº¥y tá»« KÃªnh Discord -> TÃ­ch há»£p -> Webhooks
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸš€ Triá»ƒn khai thÃ nh cÃ´ng!"
          description: |
            Bot **Em BÃ© Racoon** Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ nh cÃ´ng.
            **NgÆ°á»i triá»ƒn khai:** `${{ github.actor }}`
            **Commit:** `[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`
          color: "3447003" # MÃ u xanh
          timestamp: true