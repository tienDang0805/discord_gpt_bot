# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo ">>> KÃ­ch hoáº¡t mÃ´i trÆ°á»ng NVM vÃ  Node.js..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo ">>> Di chuyá»ƒn Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n..."
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> Äáº·t láº¡i tráº¡ng thÃ¡i Git cá»¥c bá»™ Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t..."
            git fetch origin
            git reset --hard origin/main 

            echo ">>> KÃ©o code má»›i nháº¥t tá»« nhÃ¡nh main..."
            git checkout main
            git pull origin main

            echo ">>> Sá»­ dá»¥ng Node.js phiÃªn báº£n 22..."
            nvm use 22

            echo ">>> CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c..."
            npm install

            echo ">>> Táº¡o file .env tá»« GitHub Secrets..."
            cat <<EOF > src/.env
            AUTO_REPLY_PROMPT='${{ secrets.AUTO_REPLY_PROMPT }}'
            ADMIN_ID=${{ secrets.ADMIN_ID }}
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            SYSTEM_PROMPT='${{ secrets.SYSTEM_PROMPT }}'
            CORE_RULES='${{ secrets.CORE_RULES }}'

            EOF

            echo ">>> Khá»Ÿi Ä‘á»™ng láº¡i bot báº±ng PM2..."
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save
            echo "âœ… Bot Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai vÃ  khá»Ÿi Ä‘á»™ng láº¡i!"

            echo ">>> Táº¡o vÃ  cháº¡y script gá»­i thÃ´ng bÃ¡o Discord..."
            # Sá»¬A Lá»–I 1: ThÃªm dáº¥u nhÃ¡y Ä‘Æ¡n '' vÃ o 'EOF_NODE_SCRIPT'
            # Äiá»u nÃ y ngÄƒn shell (bash) cá»‘ gáº¯ng Ä‘á»c cÃ¡c biáº¿n bÃªn trong script JavaScript
            cat << 'EOF_NODE_SCRIPT' > send_deploy_notification.js
            const { Client, GatewayIntentBits } = require("discord.js");
            const dotenv = require("dotenv");
            dotenv.config({ path: './src/.env' });

            const token = process.env.DISCORD_TOKEN;
            const channelId = process.env.DISCORD_CHANNEL_ID;
            const commitSha = process.env.GITHUB_SHA ? process.env.GITHUB_SHA.substring(0, 7) : "N/A";
            const repoUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}`;
            const commitUrl = `${repoUrl}/commit/${process.env.GITHUB_SHA}`;
            const actor = process.env.GITHUB_ACTOR || "Unknown";

            if (!token || !channelId) {
                console.error("Lá»—i: Thiáº¿u DISCORD_TOKEN hoáº·c DISCORD_CHANNEL_ID trong file .env");
                process.exit(1);
            }

            const client = new Client({ intents: [GatewayIntentBits.Guilds] });

            client.once("ready", async () => {
                try {
                    const channel = await client.channels.fetch(channelId);
                    if (channel && channel.isTextBased()) {
                        // Sá»¬A Lá»–I 2: DÃ¹ng má»™t template string duy nháº¥t, Ä‘a dÃ²ng
                        // CÃ¡ch nÃ y sáº¡ch sáº½ vÃ  trÃ¡nh Ä‘Æ°á»£c lá»—i cÃº phÃ¡p
                        const message = `ğŸš€ **Triá»ƒn khai thÃ nh cÃ´ng!**
                        **NgÆ°á»i triá»ƒn khai:** \`${actor}\`
                        **Commit:** [${commitSha}](${commitUrl})
                        Bot Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t vÃ  khá»Ÿi Ä‘á»™ng láº¡i.`;

                        await channel.send(message);
                        console.log("ÄÃ£ gá»­i thÃ´ng bÃ¡o triá»ƒn khai thÃ nh cÃ´ng.");
                    } else {
                        console.error(`KhÃ´ng tÃ¬m tháº¥y kÃªnh hoáº·c kÃªnh khÃ´ng pháº£i lÃ  kÃªnh vÄƒn báº£n: ${channelId}`);
                    }
                } catch (error) {
                    console.error("Lá»—i khi gá»­i tin nháº¯n Discord:", error);
                } finally {
                    client.destroy();
                }
            });

            client.login(token).catch(err => {
                console.error("Lá»—i Ä‘Äƒng nháº­p Discord:", err);
                process.exit(1);
            });
            EOF_NODE_SCRIPT

            sleep 5
            GITHUB_SHA="${{ github.sha }}" GITHUB_REPOSITORY="${{ github.repository }}" GITHUB_ACTOR="${{ github.actor }}" node ./send_deploy_notification.js

            rm send_deploy_notification.js
