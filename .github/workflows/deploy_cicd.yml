# .github/workflows/deploy.yml
name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # B∆∞·ªõc 1: Checkout code ƒë·ªÉ l·∫•y th√¥ng tin commit cho vi·ªác g·ª≠i th√¥ng b√°o
      - name: Checkout code
        uses: actions/checkout@v4

      # B∆∞·ªõc 2: K·∫øt n·ªëi SSH v√† th·ª±c hi·ªán t·∫•t c·∫£ c√¥ng vi·ªác tr√™n server c·ªßa b·∫°n
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e # D·ª´ng ngay l·∫≠p t·ª©c n·∫øu c√≥ l·ªói

            echo ">>> K√≠ch ho·∫°t m√¥i tr∆∞·ªùng NVM v√† Node.js..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo ">>> Di chuy·ªÉn ƒë·∫øn th∆∞ m·ª•c d·ª± √°n..."
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> K√©o code m·ªõi nh·∫•t t·ª´ nh√°nh main..."
            git checkout main
            git pull origin main

            echo ">>> S·ª≠ d·ª•ng Node.js phi√™n b·∫£n 22..."
            nvm use 22

            echo ">>> C√†i ƒë·∫∑t c√°c g√≥i ph·ª• thu·ªôc cho production..."
            npm install --production

            echo ">>> T·∫°o file .env t·ª´ GitHub Secrets..."
            cat <<EOF > src/.env
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            GUILD_ID=${{ secrets.GUILD_ID }}
            APIKEY_WEATHER=${{ secrets.APIKEY_WEATHER }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}
            YOUTUBE_COOKIE='${{ secrets.YOUTUBE_COOKIE }}'
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DISCORD_CHANNEL_ID=${{ secrets.DISCORD_CHANNEL_ID }}
            SYSTEM_PROMPT="${{ secrets.SYSTEM_PROMPT }}"
            EOF
            
            echo ">>> Kh·ªüi ƒë·ªông l·∫°i bot b·∫±ng PM2..."
            pm2 restart racoon-discord || pm2 start index.js --name "racoon-discord"
            pm2 save

            echo "‚úÖ Tri·ªÉn khai th√†nh c√¥ng!"

      # B∆∞·ªõc 3: G·ª≠i th√¥ng b√°o ƒë·∫øn Discord (S·ª¨ D·ª§NG ACTION M·ªöI)
      - name: Send Discord Notification on Success
        # Ch·ªâ ch·∫°y b∆∞·ªõc n√†y khi c√°c b∆∞·ªõc tr√™n th√†nh c√¥ng
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          # D√πng l·∫°i webhook URL b·∫°n ƒë√£ t·∫°o
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "üöÄ Tri·ªÉn khai th√†nh c√¥ng!"
          description: |
            Bot **Em B√© Racoon** ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.
            **Ng∆∞·ªùi tri·ªÉn khai:** `${{ github.actor }}`
            **Commit:** `[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`
          color: 0x34A853 # M√†u xanh l√° c√¢y

      - name: Send Discord Notification on Failure
        # Ch·ªâ ch·∫°y b∆∞·ªõc n√†y khi c√≥ l·ªói x·∫£y ra
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "‚ùå Tri·ªÉn khai th·∫•t b·∫°i!"
          description: |
            ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh tri·ªÉn khai bot.
            **Ng∆∞·ªùi tri·ªÉn khai:** `${{ github.actor }}`
            **Commit:** `[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`
            [Xem chi ti·∫øt l·ªói t·∫°i ƒë√¢y](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          color: 0xEA4335 # M√†u ƒë·ªè